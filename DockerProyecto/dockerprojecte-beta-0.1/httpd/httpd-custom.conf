# Definimos el nombre del servidor global para evitar warnings
ServerName localhost

# VirtualHost HTTP (Puerto 80) - Redirección a HTTPS
<VirtualHost *:80>
    ServerName api.local
    ServerAlias www.api.local
    ServerName frontend.local
    ServerAlias www.frontend.local

    # Redirige todo el tráfico HTTP a HTTPS conservando el host
    RewriteEngine On
    RewriteCond %{HTTPS} off
    
    # ATENCIÓN AQUÍ:
    # Si usas docker-compose y mapeas puertos (ej: 80:80 y 443:443), usa esto:
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
    
    # Si estás mapeando puertos externos raros (ej: 7443 externo -> 443 interno),
    # el navegador necesita saber el puerto externo. Solo usa la línea de abajo si es estrictamente necesario:
    # RewriteRule ^(.*)$ https://%{HTTP_HOST}:7443$1 [R=301,L]

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>

# Virtual Host HTTPS Frontend (Puerto 443)
<VirtualHost *:443>
    ServerName frontend.local
    ServerAlias www.frontend.local
    
    # Ruta ajustada al estándar de la imagen php:apache
    DocumentRoot "/var/www/html/frontend"

    SSLEngine on
    SSLCertificateFile "/etc/apache2/certs/server.crt"
    SSLCertificateKeyFile "/etc/apache2/certs/server.key"

    <Directory "/var/www/html/frontend">
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>
    
    DirectoryIndex index.php index.html

    # Logs a la salida estándar (docker logs)
    ErrorLog /proc/self/fd/2
    CustomLog /proc/self/fd/1 combined
</VirtualHost>

# Virtual Host HTTPS API (Puerto 443)
<VirtualHost *:443>
    ServerName api.local
    ServerAlias www.api.local
    
    # Ruta ajustada
    DocumentRoot "/var/www/html/api"

    SSLEngine on
    SSLCertificateFile "/etc/apache2/certs/server.crt"
    SSLCertificateKeyFile "/etc/apache2/certs/server.key"

    <Directory "/var/www/html/api">        
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    DirectoryIndex index.php

    ErrorLog /proc/self/fd/2
    CustomLog /proc/self/fd/1 combined
</VirtualHost>